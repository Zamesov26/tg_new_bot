# DR-0004. Большой монолитный класс TgApiAccessor

## Заголовок
Большой монолитный класс TgApiAccessor с множеством ответственностей

## Контекст
Проблема обнаружена в файле `app/tg_api/accessor.py` в классе TgApiAccessor, который содержит более 20 методов для работы с разными аспектами Telegram API:
- Отправка сообщений (send_message, send_photo, send_media_group)
- Редактирование сообщений (edit_message_text, edit_message_caption, edit_message_media)
- Удаление сообщений (delete_message)
- Работа с коллбэками (answer_callback_query, edit_message_reply_markup)
- Получение обновлений (poll)
- Управление сессией (connect, disconnect)

Эта проблема затрагивает архитектуру приложения и нарушает принцип единственной ответственности. Проблема была идентифицирована как технический долг в TDR-0004 и как серьезная проблема в PDR-0004.

## Проблема / Долг
Класс TgApiAccessor нарушает принцип единственной ответственности (Single Responsibility Principle), так как имеет множество причин для изменения:
1. Добавление новых методов Telegram API
2. Изменение формата существующих методов
3. Изменение логики обработки ошибок
4. Изменение логики управления соединением
5. Изменение формата данных

Класс содержит более 300 строк кода и продолжает расти. В самом классе есть TODO-комментарий: "# TODO разбить на несколько классов использовать паттерн фасад".

Класс нарушает принцип единственной ответственности (Single Responsibility Principle), так как имеет множество причин для изменения. Это затрудняет тестирование, поддержку и расширение функциональности.

## Возможные варианты решения

1. **Разбиение на специализированные классы**:
   - Сильные стороны: Четкое разделение ответственности, улучшенная тестируемость, проще вносить изменения
   - Слабые стороны: Необходимость рефакторинга существующего кода, потенциальная сложность интеграции

2. **Использование паттерна Фасад**:
   - Сильные стороны: Сохранение совместимости с существующим кодом, четкая структура, возможность постепенного рефакторинга
   - Слабые стороны: Дополнительный уровень абстракции, потенциальная сложность

3. **Оставить как есть, но улучшить организацию**:
   - Сильные стороны: Минимальные изменения, сохранение совместимости
   - Слабые стороны: Проблемы сохраняются, технический долг продолжает накапливаться

## Принятое решение / Компромисс
TODO: Необходимо определить, будет ли проводиться рефакторинг класса TgApiAccessor. Рекомендуется использовать паттерн Фасад для постепенного разделения ответственностей.

## Последствия
Если проблема будет решена путем рефакторинга:
- Плюсы: Улучшение архитектуры, повышение тестируемости, легкость поддержки, соблюдение принципов SOLID
- Минусы: Необходимость значительного рефакторинга, потенциальные ошибки при изменении

Если проблема останется без изменений:
- Плюсы: Отсутствие необходимости в изменениях, сохранение совместимости
- Минусы: Продолжение накопления технического долга, усложнение поддержки, проблемы с тестированием, сложность тестирования из-за множества зависимостей, трудности при внесении изменений - высокий риск внесения ошибок, несоответствие принципам SOLID, затрудненная переиспользуемость кода, сложность понимания кода новыми разработчиками

## План исправления / развития
1. Разбить класс на несколько специализированных классов:
   - MessageService (для работы с сообщениями)
   - CallbackService (для работы с коллбэками)
   - UpdateService (для получения обновлений)
2. Создать фасадный класс, объединяющий все сервисы
3. Обновить зависимости в коде для использования новых классов
4. Написать тесты для каждого нового класса

## Статус
Open

## Комментарии
Класс также имеет проблемы с обработкой файлов (DR-0003) и SSL (DR-0001), что еще больше усложняет его поддержку. Решение этой проблемы может быть связано с выделением модуля в отдельную библиотеку, как описано в analysis/library_extraction_bot_engine_and_tg_api.md.

## TODO
Определить, будет ли проводиться рефакторинг класса TgApiAccessor. Рекомендуется использовать паттерн Фасад для постепенного разделения ответственностей.