# DR-0003. Незакрытые файловые дескрипторы

## Заголовок
Незакрытые файловые дескрипторы при работе с файлами

## Контекст
Проблема обнаружена в файле `app/tg_api/accessor.py` в классе TgApiAccessor:
1. Метод `send_photo` - файл открывается через `open(path_image, "rb")`, но не закрывается явно
2. Метод `send_media_group` - файлы открываются в цикле, но закрываются только в блоке после запроса
3. Метод `edit_message_media` - файл открывается через `open(file_path, "rb")`, но не закрывается явно

Эта проблема затрагивает управление ресурсами и может привести к утечке файловых дескрипторов. Проблема была идентифицирована как технический долг в TDR-0003 и как серьезная проблема в PDR-0003.

## Проблема / Долг
В коде используется функция `open()` без гарантии закрытия файлового дескриптора:
```python
# Пример из send_photo
value=open(path_image, "rb")

# Пример из send_media_group
files[f"media{i}"] = open(item["file_path"], "rb")
```

В долгоживущих приложениях, таких как Telegram-боты, это может со временем привести к исчерпанию доступных файловых дескрипторов и сбоям приложения. Особенно критично в методе `send_media_group`, где в цикле открываются несколько файлов.

Использование функции `open()` без гарантии закрытия файлового дескриптора может привести к утечке ресурсов. В долгоживущих приложениях, таких как Telegram-боты, это может со временем привести к исчерпанию доступных файловых дескрипторов и сбоям приложения.

## Возможные варианты решения

1. **Использование контекстных менеджеров**:
   - Сильные стороны: Гарантированное закрытие файлов, даже при возникновении исключений, следование лучшим практикам Python
   - Слабые стороны: Необходимость изменения логики работы с файлами, потенциальная сложность с асинхронными операциями

2. **Явное закрытие файлов с обработкой исключений**:
   - Сильные стороны: Более прямолинейный подход, совместимость с существующим кодом
   - Слабые стороны: Риск забыть закрыть файл, сложность с обработкой всех путей выполнения

3. **Использование временных файлов и буферов в памяти**:
   - Сильные стороны: Исключение работы с файловыми дескрипторами, потенциально лучшая производительность
   - Слабые стороны: Потенциальные проблемы с памятью при больших файлах, необходимость изменения архитектуры

## Принятое решение / Компромисс
TODO: Необходимо определить, какой подход будет использоваться для решения проблемы с файловыми дескрипторами. Рекомендуется использовать контекстные менеджеры для гарантированного закрытия файлов.

## Последствии
Если проблема будет решена с использованием контекстных менеджеров:
- Плюсы: Гарантированное закрытие файлов, устранение утечки ресурсов, соответствие лучшим практикам
- Минусы: Необходимость изменения логики работы с файлами, потенциальная сложность интеграции с aiohttp

Если проблема останется без изменений:
- Плюсы: Отсутствие необходимости в изменениях
- Минусы: Риск утечки файловых дескрипторов, потенциальные сбои приложения при длительной работе, утечка файловых дескрипторов, потенциальные сбои приложения при исчерпании файловых дескрипторов, несоответствие лучшим практикам работы с файлами, потенциальные проблемы с производительностью

## План исправления / развития
1. Заменить использование `open()` на контекстные менеджеры (`with` statement)
2. Убедиться, что все открытые файлы корректно закрываются даже в случае исключений
3. Проверить все места в коде, где используются файловые операции
4. Добавить тесты для проверки корректного закрытия файловых дескрипторов
5. Важно также рассмотреть использование aiohttp FormData с файлами в режиме потоковой передачи для более эффективной работы с большими файлами

## Статус
Open

## Комментарии
Важно также рассмотреть использование aiohttp FormData с файлами в режиме потоковой передачи для более эффективной работы с большими файлами. Проблема также упоминается в анализе library_extraction_bot_engine_and_tg_api.md.

## TODO
Определить, какой подход будет использоваться для решения проблемы с файловыми дескрипторами. Рекомендуется использовать контекстные менеджеры для гарантированного закрытия файлов.