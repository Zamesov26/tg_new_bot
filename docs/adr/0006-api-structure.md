# 0006. Структура API

## Дата
2025-08-27

## Статус
Accepted

## Контекст
Проект использует aiohttp для создания веб-API. Необходимо определить структуру API и подход к организации endpoint'ов.

Требования:
- Четкая организация endpoint'ов
- Единообразная обработка запросов и ответов
- Легкость добавления новых endpoint'ов
- Разделение бизнес-логики от слоя представления
- Поддержка middleware

## Решение
Использовать классы View из aiohttp с наследованием от кастомного базового класса.

### Структура:
1. Кастомные классы Application, Request и View для расширения функциональности
2. Организация endpoint'ов по функциональным модулям
3. Использование middleware для общей функциональности (логирование, обработка ошибок)
4. Стандартные HTTP-методы для REST-подобного API

### Пример структуры:
```
/app/web/
  ├── app.py          # Application, Request, View classes
  ├── mixins.py       # Общие миксины
  └── utils.py        # Вспомогательные функции
```

### Обработка запросов:
1. Request содержит ссылку на Application
2. View имеет доступ к database и store через request
3. Данные из запроса доступны через self.request.get("data", {})

## Альтернативы
1. **Использование aiohttp-apispec для документирования API**:
   - Плюсы: Автоматическая генерация документации, валидация
   - Минусы: Дополнительная сложность, проект в основном Telegram-бот
   
2. **FastAPI**:
   - Плюсы: Автоматическая документация, валидация, асинхронность
   - Минусы: Необходимость переписывания существующего кода, избыточность для текущих потребностей
   
3. **Flask/Falcon**:
   - Плюсы: Простота, меньшая абстракция
   - Минусы: Меньше встроенных возможностей, необходимость реализации многих функций самостоятельно

## Последствия
**Положительные**:
- Единообразная структура для всех endpoint'ов
- Расширяемость через наследование
- Четкое разделение ответственности
- Интеграция с существующей архитектурой (store, database)

**Отрицательные**:
- Некоторая избыточность для простых endpoint'ов
- Необходимость понимания кастомной архитектуры для новых разработчиков

## Ретроспектива
Кастомная архитектура хорошо справляется с текущими задачами. Позволяет легко добавлять новые endpoint'ы и расширять функциональность.

## Связанные ADR
- 0001. передача сущностей в ручку
- 0003. Выбор базы данных и ORM