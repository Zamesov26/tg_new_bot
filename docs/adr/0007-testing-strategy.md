# 0007. Стратегия тестирования

## Дата
2025-08-27

## Статус
Proposed

## Контекст
Для обеспечения качества кода и предотвращения регрессий необходимо определить стратегию тестирования проекта.

Требования:
- Покрытие критической бизнес-логики тестами
- Возможность запуска тестов в CI/CD
- Поддержка асинхронного кода
- Легкость написания и поддержки тестов
- Изоляция тестов (отдельная тестовая база данных)

## Решение
Использовать pytest с расширениями pytest-asyncio и pytest-aiohttp для тестирования.

### Подход:
1. **Unit-тесты**: Тестирование отдельных функций и классов
2. **Интеграционные тесты**: Тестирование взаимодействия компонентов
3. **End-to-end тесты**: Тестирование полных сценариев работы бота (TODO: Определить необходимость)

### Структура тестов:
```
/tests/
  ├── unit/              # Unit-тесты
  ├── integration/       # Интеграционные тесты
  └── conftest.py        # Общая конфигурация pytest
```

### Инструменты:
1. **pytest**: Основной фреймворк для тестирования
2. **pytest-asyncio**: Поддержка асинхронных тестов
3. **pytest-aiohttp**: Утилиты для тестирования aiohttp-приложений
4. **Фикстуры**: Для подготовки тестовых данных и среды

### Покрытие:
1. Accessor'ы (работа с данными)
2. Хендлеры (бизнес-логика)
3. API endpoint'ы
4. FSM (машина состояний)

## Альтернативы
1. **unittest (стандартная библиотека)**:
   - Плюсы: Нет внешних зависимостей
   - Минусы: Более громоздкий синтаксис, меньше возможностей
   
2. **nose2**:
   - Плюсы: Расширение возможностей unittest
   - Минусы: Меньшее сообщество, менее активная разработка
   
3. **behave (BDD)**:
   - Плюсы: Тестирование в терминах бизнес-логики, понятно для non-technical stakeholders
   - Минусы: Более сложная настройка, избыточность для текущего проекта

## Последствия
**Положительные**:
- Распространенные и хорошо документированные инструменты
- Поддержка асинхронного кода
- Легкость написания тестов
- Интеграция с CI/CD

**Отрицательные**:
- Необходимость создания тестовой инфраструктуры (фикстуры, тестовая БД)
- Потенциальное замедление CI/CD pipeline
- Необходимость поддержки тестов при изменении кода

## Ретроспектива
TODO: Заполнить после внедрения тестов

## Связанные ADR
- 0009. CI/CD